虚拟化主要是通过一个叫做 Hypervisor 的程序实现的。Hypervisor 直接安装在物理机上，多个虚拟机在 Hypervisor 上运行。Hypervisor 实现方式一般是一个特殊定制的 Linux 系统。根据 Hypervisor 的实现方式和所处的位置，虚拟化又分为两种：1型虚拟化和2型虚拟化。

## 1型虚拟化

 

<img src="https://gitee.com/fjboy/cdn/raw/image-bed/2021/12/17/image-20211215183606694.png" alt="image-20211215183606694" style="zoom:50%;" />



## 2型虚拟化
 物理机上首先安装常规的操作系统，比如 Redhat Windows。Hypervisor 作为 OS 上的一个程序模块运行，并对管理虚拟机进行管理。KVM、VirtualBox 和 VMWare Workstation 都属于这个类型。



<img src="https://gitee.com/fjboy/cdn/raw/image-bed/2021/12/17/image-20211215183508541.png" alt="image-20211215183508541" style="zoom:50%;" />

在 x86 平台上最热门运用最广泛的虚拟化方案莫过于 KVM 了。OpenStack 对 KVM 支持得也最好，

KVM 全称是 Kernel-Based Virtual Machine。也就是说 KVM 是基于 Linux 内核实现的。

KVM有一个内核模块叫 kvm.ko，只用于管理虚拟 CPU 和内存。 IO 的虚拟化则交给 Linux 内核和Qemu来实现。

 Libvirt 是kvm 的管理工具，除了能管理 KVM 这种 Hypervisor，还能管理 Xen，VirtualBox 等。OpenStack 底层也使用 Libvirt。

## cpu虚拟化

一个 KVM 虚机在宿主机中其实是一个 qemu-kvm 进程，与其他 Linux 进程一样被调度。

虚机中的每一个虚拟 vCPU 则对应 qemu-kvm 进程中的一个线程。

<img src="https://gitee.com/fjboy/cdn/raw/image-bed/2021/12/17/image-20211215183710833.png" alt="image-20211215183710833" style="zoom:80%;" />

## 内存虚拟化

KVM 通过内存虚拟化共享物理系统内存，动态分配给虚拟机。

![image-20211215183738934](https://gitee.com/fjboy/cdn/raw/image-bed/2021/12/17/image-20211215183738934.png)

KVM 需要实现 VA（虚拟内存） -> PA（物理内存） -> MA（机器内存）之间的地址转换。

虚机 OS 控制虚拟地址到客户内存物理地址的映射 （VA -> PA），但是虚机 OS 不能直接访问实际机器内存，因此 KVM 需要负责映射客户物理内存到实际机器内存 （PA -> MA）。

## 存储虚拟化

 KVM 的存储虚拟化是通过存储池（Storage Pool）和卷（Volume）来管理的。

 Storage Pool 是宿主机上可以看到的一片存储空间，可以是多种类型。Volume 是在 Storage Pool 中划分出的一块空间，宿主机将 Volume 分配给虚拟机，Volume 在虚拟机中看到的就是一块硬盘。

1. 文件目录型的 Storage Pool 

KVM 将宿主机目录 /var/lib/libvirt/images/ 作为默认的 Storage Pool。Volume 是该目录下面的文件了，一个文件就是一个 Volume。

2. 

 